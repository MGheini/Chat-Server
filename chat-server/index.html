<!-- In the Name of God -->
<!-- We hate Semantic UI. -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Chat</title>
    <link rel="stylesheet" type="text/css" href="static/semantic/semantic.min.css" />
    <link rel="stylesheet" type="text/css" href="static/css/style.css" />
</head>
<body>
    <div class="ui small test visible active modal" style="margin-top: -120px;">
        <div class="header">
          View Your Account
      </div>
      <div class="ui input focus content">
          <p><input id="full-name" type="text" placeholder="Full Name" style="margin-left: 145px"></p>
          <p><input id="username" type="text" placeholder="Username" style="margin-left: 145px"></p>
      </div>
      <div class="actions">
        <div id="login" class="ui positive button">
            Login
        </div>
    </div>
</div>

<div id="error-msg" class="ui negative message" style="width: 500px; margin: auto; margin-top: 20px; visibility: hidden;">
  <div class="header" style="text-align: center;">
    Sorry, but no member with the entered username was found
</div>
</div>

<div id="container" class="ui grid">
    <div id="friends-list" class="five wide column">
        <div class="ui raised stacked segment" id="user-info">
            <h2 class="ui icon center aligned header">
                <img src="static/avatars/5.jpg" class="ui circular image">
                <div class="content">
                    <h2 id="welcome-msg">Welcome!</h2>
                    <div id="display-username" class="sub header"></div>
                </div>
            </h2>
        </div>
        <div class="ui vertical menu left" id="roster">
            <div class="item">
                <div class="ui transparent icon input">
                    <input id="new-friend" type="text" placeholder="Add a friend...">
                    <i class="user icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="messages-pane" class="eleven wide column">
        <div id="message-header">
            <h2 class="ui header">
                <i class="comments icon"></i>
                <div class="content">
                    Conversation with @<span id="receiver"></span>
                    <div class="sub header"></div>
                </div>
            </h2>
        </div>

        <div id="messages">
            <div class="ui minimal comments">
                <div class="comment">
                    <a class="avatar">
                        <img src="static/avatars/1.jpg">
                    </a>
                    <div class="content">
                        <a class="author">Sadjad</a>
                        <div class="metadata">
                            <span class="date">Today at 5:42PM</span>
                        </div>
                        <div class="text">
                            Jane, did you see the project definition?
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="message-form-container">
            <form class="ui form">
                <div class="ui action input">
                    <input id="message-text" type="text" placeholder="Your message here..." dir="auto">
                    <div id="send" class="ui green icon button">
                        <i class="send icon"></i> &nbsp;Send
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="static/js/socket.io-1.2.0.js"></script>
<script src="static/js/jquery-2.1.4.min.js"></script>
<script src="static/semantic/semantic.min.js"></script>
<script>
    var socket = io();

    var fullName = document.getElementById('full-name');
    var username = document.getElementById('username');

    $('#login').click(function() {
        $('.modal').modal('hide');
        var userDataObject = {
            username: username.value
        }
        document.getElementById('welcome-msg').innerHTML = "Welcome, " + fullName.value + "!";
        document.getElementById('display-username').innerHTML = "@" + username.value;
        
        socket.emit('login', userDataObject);
    });

    socket.on('login', function(object) {
        for (i = 0; i < object.friends.length; i++) {
            var friendItem = document.createElement('a');
            if (object.friends[i].status === true)
                friendItem.className = 'active green item';
            else
                friendItem.className = 'blue item';
            var friendId = document.createTextNode(object.friends[i].friend);
            friendItem.appendChild(friendId);
            document.getElementById('roster').appendChild(friendItem);
        }
    });

    $('#send').click(function(){
        var receiverUsername = document.getElementById('receiver');
        var messageText = document.getElementById('message-text');

        if (messageText.value) {
            var messageObject = {
                sender: username.value,
                receiver: receiverUsername.innerHTML,
                messageText: messageText.value,
                datetime: new Date().toUTCString()
            }
            messageText.value = "";
            socket.emit('send message', messageObject);
        }
    });

    document.getElementById('new-friend').onkeypress = function(e) {
        if (!e) e = window.event;
        if (e.keyCode == '13') {
            if (this.value) {
                var friendshipObject = {
                    username: username.value,
                    friend: this.value
                }
                this.value = "";
                socket.emit('add friend', friendshipObject);
            }
            return false;
        }
    }

    socket.on('added friend', function(object) {
        var friend = document.createElement('a');
        if (object.status === true)
            friend.className = 'active green item';
        else
            friend.className = 'blue item';
        var friendId = document.createTextNode(object.friend);
        friend.appendChild(friendId);
        document.getElementById('roster').appendChild(friend);
    });

    socket.on('no such member', function() {
        var error = document.getElementById('error-msg');
        error.style.visibility = 'visible';
        setTimeout(function() {
            error.style.visibility = 'hidden';
        }, 3000);
    });

    socket.on('online friend', function(object) {
        $( 'a.blue.item' ).each( function(){
            if ($( this ).text() === object.friend) {
                $ ( this ).attr('class', 'active green item');
            }
        });
    });

    socket.on('offline friend', function(object) {
        $( 'a.green.item' ).each( function(){
            if ($( this ).text() === object.friend) {
                $( this ).attr('class', 'blue item');
            }
        });
    });    

    $(window).on("beforeunload", function(object) { 
        var userDataObject = {
            username: username.value
        }
        socket.emit('logout', userDataObject);
    });
</script>
</body>
</html>
